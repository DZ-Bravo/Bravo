# 람다 함수 사용 가이드

## 구조 변경으로 타임아웃 해결

### 변경 전 문제점
- 에이전트가 KB 검색 결과를 직접 파싱/필터링 → 프롬프트 복잡도 증가
- 긴 프롬프트 + 많은 KB 결과 → 모델 타임아웃 (424 에러)

### 변경 후 구조
```
사용자 입력
  ↓
에이전트 (변수 추출: region, difficulty)
  ↓
람다1: course-filter (KB 결과 파싱 + 필터링 + 정렬)
  ↓
에이전트 (선별된 코스들 받음)
  ↓
람다2: weather-fetcher (각 코스의 날씨 조회)
  ↓
에이전트 (날씨 포함 최종 3개 선정 + 설명)
```

### 타임아웃 해결 이유
1. **프롬프트 단순화**: 파싱/필터링 로직 제거 → 프롬프트 70% 감소
2. **처리 부담 감소**: 람다가 빠르게 처리 → 에이전트는 날씨 조회 + 최종 선정만
3. **KB 결과 축소**: 람다가 상위 10개만 반환 → 에이전트 처리량 감소

## 람다 함수 1: course-filter

### 입력 형식
```json
{
  "kb_results": [
    "chunk1_text...",
    "chunk2_text..."
  ],
  "region": "부산",  // 선택: "서울", "부산", "경기" 등
  "difficulty": "쉬움",  // 선택: "쉬움", "보통", "어려움"
  "limit": 10  // 선택: 반환할 최대 코스 수 (기본 10)
}
```

### 출력 형식
```json
{
  "statusCode": 200,
  "body": "{\"courses\": [...], \"count\": 10}"
}
```

### 에이전트에서 호출 예시
```
1. KB 검색 수행
2. 검색 결과 + 사용자 요청 분석
3. 람다 호출:
   - kb_results: KB 검색 결과 chunk들
   - region: "부산" (사용자가 "부산 산" 요청 시)
   - difficulty: "쉬움" (사용자가 "초보" 요청 시)
4. 람다 결과 받아서 날씨 조회
```

## 람다 함수 2: weather-fetcher (기존 유지)

### 입력 형식
```json
{
  "latitude": 35.1944152,
  "longitude": 129.1446902
}
```

### 출력 형식
```json
{
  "weather_main": "Clear",
  "weather_description": "clear sky",
  "temperature": 15.5,
  "wind_speed": 3.2
}
```

## 에이전트 프롬프트 변경

### 변경 전 (복잡)
- KB 검색 결과 파싱 방법 상세 설명
- 지역 필터링 로직 설명
- 난이도 필터링 로직 설명
- 정렬 방법 설명
- ... (2000+ 토큰)

### 변경 후 (단순)
```
당신은 등산 코스 추천 전문 에이전트입니다.

작업 순서:
1. KB 검색: 사용자 요청에 맞게 검색
2. 변수 추출: 사용자 요청에서 region(지역), difficulty(난이도) 추출
3. 람다 호출: course-filter 람다에 kb_results, region, difficulty 전달
4. 날씨 조회: 선별된 코스들의 latitude, longitude로 weather-fetcher 호출
5. 최종 선정: 날씨 좋은 순으로 3개 선정 + 설명

출력 형식:
추천 코스:
1. [산 이름] - [코스 이름] 거리 Xkm, Y분, 난이도. 날씨: [상태]
2. ...
3. ...
```

## 예상 효과

### 타임아웃 해결
- ✅ 프롬프트 70% 감소 → 모델 처리 시간 단축
- ✅ KB 결과 10개만 처리 → 입력 토큰 감소
- ✅ 람다가 빠른 처리 → 에이전트 대기 시간 감소

### 성능 개선
- ✅ 응답 시간: 7초 → 3초 예상
- ✅ 타임아웃 에러: 424 → 해결 예상
- ✅ 정확도: 람다 로직으로 일관성 향상


