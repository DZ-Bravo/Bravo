name: "ğŸš€ Deploy frontend service"

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Harbor ì´ë¯¸ì§€ íƒœê·¸ (ì˜ˆ: latest, 1.5 ë“±)"
        required: true
        default: "latest"

jobs:
  deploy:
    runs-on: self-hosted       # Runnerê°€ ì„¤ì¹˜ëœ ë°°í¬ ì„œë²„
    env:
      REGISTRY_HOST: "192.168.0.240"
      HARBOR_PROJECT: "mywork"
      SERVICE_NAME: "services-frontend"   # docker images ì´ë¦„ê³¼ ë§¤ì¹­
      COMPOSE_FILE: "/home/bravo/LABs/services/docker-compose.yml"

    steps:
      - name: ğŸ” íƒœê·¸ ì¶œë ¥
        run: echo "Deploying tag: ${{ github.event.inputs.image_tag }}"

      - name: ğŸ“¥ ì´ë¯¸ì§€ Pull
        run: |
          IMAGE="${REGISTRY_HOST}/${HARBOR_PROJECT}/${SERVICE_NAME}:${{ github.event.inputs.image_tag }}"
          echo "Pulling $IMAGE"
          docker pull "$IMAGE"

      - name: ğŸ· latest íƒœê·¸ ê°±ì‹  (optional)
        run: |
          LATEST="${REGISTRY_HOST}/${HARBOR_PROJECT}/${SERVICE_NAME}:latest"
          IMAGE="${REGISTRY_HOST}/${HARBOR_PROJECT}/${SERVICE_NAME}:${{ github.event.inputs.image_tag }}"
          docker tag "$IMAGE" "$LATEST"
          docker push "$LATEST" || true

      - name: ğŸ”„ ì„œë¹„ìŠ¤ë§Œ ì¬ë°°í¬
        run: |
          cd "$(dirname "$COMPOSE_FILE")"
          docker compose pull $SERVICE_NAME
          docker compose up -d $SERVICE_NAME

      - name: ğŸ§ª Health Check
        run: |
          sleep 5
          docker ps | grep $SERVICE_NAME || exit 1
