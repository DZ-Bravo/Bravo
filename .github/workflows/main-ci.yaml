name: Scan, Test, and Deploy to Harbor

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  REGISTRY_HOST: 192.168.0.240
  HARBOR_PROJECT: ${{ vars.HARBOR_PROJECT || 'mywork' }}

jobs:
  sonarqube:
    name: SonarQube Analysis
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          # 
          SONAR_HOST_URL: http://192.168.0.240:9000
        with:
          args: >
            -Dsonar.projectKey=DZ-CI-CD-Project
            -Dsonar.projectName=DZ-CI-CD-Project
            -Dsonar.sources=backend,frontend
            -Dsonar.exclusions=**/node_modules/**,**/.next/**,frontend/app/public/**,**/build/**,**/dist/**,**/coverage/**

      - name: Check Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          # 
          SONAR_HOST_URL: http://192.168.0.240:9000

  prepare-version:
    name: Determine Image Version
    runs-on: ubuntu-latest
    needs:
      - sonarqube
    outputs:
      image_version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version
        id: version
        run: |
          git fetch --tags
          latest_tag=$(git tag --list 'v1.*' --sort=-v:refname | head -n 1)
          if [ -z "$latest_tag" ]; then
            next_minor=0
          else
            latest_minor=${latest_tag#v1.}
            next_minor=$((latest_minor + 1))
          fi
          version="1.${next_minor}"
          echo "version=$version" >> "$GITHUB_OUTPUT"

  build-and-push:
    name: Build, Scan, and Push Images
    runs-on: [self-hosted, Linux, X64]
    needs:
      - prepare-version
    env:
      IMAGE_VERSION: ${{ needs.prepare-version.outputs.image_version }}
      HARBOR_CA_CRT: ${{ secrets.HARBOR_CA_CRT }}
    strategy:
      fail-fast: false
   
