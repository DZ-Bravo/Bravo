name: Smart CI/CD - Scan, Detect Changes, Build, Push

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  REGISTRY_HOST: 192.168.0.240
  HARBOR_PROJECT: ${{ vars.HARBOR_PROJECT || 'service' }}

jobs:
  # ==============================
  # 1) SonarQube ì½”ë“œ ë¶„ì„
  # ==============================
  sonarqube:
    name: SonarQube Analysis
    runs-on: [self-hosted, Linux, X64]
    steps:
      - uses: actions/checkout@v4

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=DZ-CI-CD-Project
            -Dsonar.projectName=DZ-CI-CD-Project
            -Dsonar.sources=services
            -Dsonar.exclusions=**/node_modules/**,**/.next/**,**/build/**,**/dist/**,**/coverage/**,**/shared/**

  # ==============================
  # 2) Version ìë™ ì¦ê°€ step (Harbor ì´ë¯¸ì§€ íƒœê·¸ ê¸°ë°˜)
  # ==============================
  prepare-version:
    name: Determine Version
    runs-on: [self-hosted, Linux, X64]
    needs: sonarqube
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Determine next version from Harbor
        id: version
        env:
          REGISTRY_HOST: ${{ env.REGISTRY_HOST }}
          HARBOR_PROJECT: ${{ env.HARBOR_PROJECT }}
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          # Harbor ë¡œê·¸ì¸
          echo "$HARBOR_PASSWORD" | docker login $REGISTRY_HOST -u "$HARBOR_USERNAME" --password-stdin
          
          # frontend ì„œë¹„ìŠ¤ì˜ íƒœê·¸ í™•ì¸ (ê¸°ì¤€ ì„œë¹„ìŠ¤ë¡œ ì‚¬ìš©)
          LATEST_VERSION="0"
          
          # Harbor API v2.0ìœ¼ë¡œ íƒœê·¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          # API ì‘ë‹µì—ì„œ ëª¨ë“  íƒœê·¸ ì¶”ì¶œ
          API_RESPONSE=$(curl -s -k -u "$HARBOR_USERNAME:$HARBOR_PASSWORD" \
            "https://$REGISTRY_HOST/api/v2.0/projects/$HARBOR_PROJECT/repositories/frontend/artifacts?page_size=100" 2>/dev/null || echo "")
          
          if [ -n "$API_RESPONSE" ] && [ "$API_RESPONSE" != "[]" ] && [ "$API_RESPONSE" != "null" ]; then
            # jqê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ grep/sedë¡œ íŒŒì‹±
            if command -v jq &> /dev/null; then
              # jqë¥¼ ì‚¬ìš©í•œ ì•ˆì •ì ì¸ íŒŒì‹±
              TAGS=$(echo "$API_RESPONSE" | jq -r '.[].tags[]?.name // empty' 2>/dev/null | grep -E '^1\.[0-9]+$' | sort -V)
            else
              # grep/sedë¥¼ ì‚¬ìš©í•œ íŒŒì‹± (ë” ê´€ëŒ€í•œ íŒ¨í„´)
              TAGS=$(echo "$API_RESPONSE" | grep -oE '"(name|tag)":"1\.[0-9]+"' | sed 's/.*"\(1\.[0-9]\+\)".*/\1/' | sort -V | uniq)
            fi
            
            if [ -n "$TAGS" ]; then
              # ê°€ì¥ ë†’ì€ ë²„ì „ ì°¾ê¸°
              LATEST_TAG=$(echo "$TAGS" | tail -1)
              if [ -n "$LATEST_TAG" ] && [[ "$LATEST_TAG" =~ ^1\.([0-9]+)$ ]]; then
                # ë§ˆì´ë„ˆ ë²„ì „ ì¶”ì¶œ (ì˜ˆ: 1.14 â†’ 14)
                MINOR_VERSION="${BASH_REMATCH[1]}"
                if [ -n "$MINOR_VERSION" ] && [ "$MINOR_VERSION" -ge 0 ] 2>/dev/null; then
                  LATEST_VERSION=$MINOR_VERSION
                fi
              fi
            fi
          fi
          
          # ë‹¤ìŒ ë²„ì „ ê³„ì‚° (1.0, 1.1, 1.2...)
          NEXT_VERSION=$((LATEST_VERSION + 1))
          VERSION="1.${NEXT_VERSION}"
          
          echo "Latest version in Harbor: 1.${LATEST_VERSION}"
          echo "Next version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  # ==============================
  # 3) ì„œë¹„ìŠ¤ ë³€ê²½ ê°ì§€ + Build + Push (ë³‘ë ¬)
  # ==============================
  build-and-push:
    name: Build Changed Services & Deploy to Harbor
    # âš ï¸ ì£¼ì˜: 192.168.0.240ì€ ì‚¬ì„¤ IPì´ë¯€ë¡œ GitHub-hosted runnerì—ì„œ ì ‘ê·¼ ë¶ˆê°€
    # self-hosted runnerë¥¼ ì‚¬ìš©í•´ì•¼ í•¨ (ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì—¬ëŸ¬ runner ë“±ë¡ í•„ìš”)
    runs-on: [self-hosted, Linux, X64]
    needs: prepare-version

    strategy:
      fail-fast: false
      # ë³‘ë ¬ ì²˜ë¦¬: self-hosted runnerê°€ ì—¬ëŸ¬ ê°œ ë“±ë¡ë˜ì–´ ìˆì–´ì•¼ ë³‘ë ¬ ì‹¤í–‰ë¨
      # runnerê°€ í•˜ë‚˜ë§Œ ìˆìœ¼ë©´ ìˆœì°¨ ì‹¤í–‰ë¨
      # í•´ê²°: ê°™ì€ ë¼ë²¨(self-hosted, Linux, X64)ë¡œ ì—¬ëŸ¬ VMì— runner ë“±ë¡
      matrix:
        service:
          [
            # í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤
            "frontend-service",
            
            # ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë“¤
            "backend-services/ai-service",           # AI ì„œë¹„ìŠ¤
            "backend-services/auth-service",          # ì¸ì¦ ì„œë¹„ìŠ¤
            "backend-services/chatbot-service",      # ì±—ë´‡ ì„œë¹„ìŠ¤
            "backend-services/community-service",    # ì»¤ë®¤ë‹ˆí‹° ì„œë¹„ìŠ¤
            "backend-services/mountain-service",     # ì‚° ì •ë³´ ì„œë¹„ìŠ¤
            "backend-services/notice-service",       # ê³µì§€ì‚¬í•­ ì„œë¹„ìŠ¤
            "backend-services/notification-service", # ì•Œë¦¼ ì„œë¹„ìŠ¤
            "backend-services/schedule-service",     # ì¼ì • ì„œë¹„ìŠ¤
            "backend-services/stamp-service",        # ìŠ¤íƒ¬í”„ ì„œë¹„ìŠ¤
            "backend-services/store-service",        # ìŠ¤í† ì–´ ì„œë¹„ìŠ¤
          ]

    env:
      VERSION: ${{ needs.prepare-version.outputs.version }}
      HARBOR_CA_CRT: ${{ secrets.HARBOR_CA_CRT }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ìµœì‹  ì»¤ë°‹ë§Œ (ì „ì²´ íˆìŠ¤í† ë¦¬ ë¶ˆí•„ìš”)
          # ë°±ì—”ë“œëŠ” services/ ì „ì²´ê°€ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ë¡œ í•„ìš”í•˜ë¯€ë¡œ sparse-checkout ì‚¬ìš© ë¶ˆê°€
          # ì²´í¬ì•„ì›ƒ ì‹œê°„ì€ ì €ì¥ì†Œ í¬ê¸°ì— ë¹„ë¡€í•˜ì§€ë§Œ, fetch-depth: 1ë¡œ ìµœì†Œí™”

      # --- Harbor CA ì¸ì¦ì„œ ì„¤ì¹˜ ---
      - name: Install Harbor CA certificate
        if: ${{ env.HARBOR_CA_CRT != '' }}
        run: |
          mkdir -p ~/.docker/certs.d/${{ env.REGISTRY_HOST }}
          printf '%s\n' "$HARBOR_CA_CRT" > ~/.docker/certs.d/${{ env.REGISTRY_HOST }}/ca.crt

      # --- Docker Buildx ì„¤ì • ---
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- ë³€ê²½ ê°ì§€ ---
      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            modified:
              - 'services/${{ matrix.service }}/**'
              - 'services/shared/**'  # shared ë³€ê²½ ì‹œì—ë„ ë¹Œë“œ í•„ìš”

      # --- ë³€ê²½ ê°ì§€ ê²°ê³¼ ì¶œë ¥ (ë””ë²„ê¹…) ---
      - name: Show change detection result
        run: |
          echo "Service: ${{ matrix.service }}"
          echo "Modified: ${{ steps.changes.outputs.modified }}"
          echo "All changes: ${{ steps.changes.outputs.all_modified }}"

      # --- ë³€ê²½ ì—†ìœ¼ë©´ skip ---
      - name: Skip if no changes
        if: steps.changes.outputs.modified != 'true'
        run: echo "â­ No changes detected for ${{ matrix.service }}"

      # --- Harbor ì ‘ê·¼ í…ŒìŠ¤íŠ¸ ---
      - name: Test Harbor connectivity
        if: steps.changes.outputs.modified == 'true'
        run: |
          echo "ğŸ” Testing Harbor connectivity..."
          if curl -k -I https://${{ env.REGISTRY_HOST }} 2>&1 | grep -q "200 OK"; then
            echo "âœ… Harbor is accessible"
          else
            echo "âŒ Harbor is NOT accessible from this runner"
            echo "   Registry: ${{ env.REGISTRY_HOST }}"
            exit 1
          fi

      # --- Build & Push if changed ---
      - name: Login to Harbor
        if: steps.changes.outputs.modified == 'true'
        run: |
          echo "ğŸ” Logging in to Harbor..."
          echo "${{ secrets.HARBOR_PASSWORD }}" | docker login ${{ env.REGISTRY_HOST }} -u "${{ secrets.HARBOR_USERNAME }}" --password-stdin
          echo "âœ… Harbor login successful"

      - name: Determine image name and build context
        if: steps.changes.outputs.modified == 'true'
        id: build-config
        run: |
          # ì„œë¹„ìŠ¤ ì´ë¦„ ì¶”ì¶œ (ìŠ¬ë˜ì‹œ ì œê±°, í•˜ì´í”ˆìœ¼ë¡œ ë³€í™˜)
          IMAGE_NAME=$(echo "${{ matrix.service }}" | sed 's|backend-services/||' | sed 's|frontend-service|frontend|')
          
          # í”„ë¡ íŠ¸ì—”ë“œëŠ” frontend-service ë””ë ‰í† ë¦¬ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ, ë°±ì—”ë“œëŠ” services ë””ë ‰í† ë¦¬ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ
          if [[ "${{ matrix.service }}" == "frontend-service" ]]; then
            BUILD_CONTEXT="services/frontend-service"
            DOCKERFILE="services/frontend-service/Dockerfile"
          else
            BUILD_CONTEXT="services"
            DOCKERFILE="services/${{ matrix.service }}/Dockerfile"
          fi
          
          echo "image_name=$IMAGE_NAME" >> "$GITHUB_OUTPUT"
          echo "build_context=$BUILD_CONTEXT" >> "$GITHUB_OUTPUT"
          echo "dockerfile=$DOCKERFILE" >> "$GITHUB_OUTPUT"
          IMAGE_REF="${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/$IMAGE_NAME:${{ env.VERSION }}"
          echo "image_ref=$IMAGE_REF" >> "$GITHUB_OUTPUT"
          echo "ğŸ“¦ Image will be built as: $IMAGE_REF"
          echo "ğŸ“¦ Latest tag: ${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/$IMAGE_NAME:latest"

      - name: Build Image
        if: steps.changes.outputs.modified == 'true'
        run: |
          docker build \
            -f ${{ steps.build-config.outputs.dockerfile }} \
            -t ${{ steps.build-config.outputs.image_ref }} \
            ${{ steps.build-config.outputs.build_context }}

      - name: Trivy vulnerability scan
        if: steps.changes.outputs.modified == 'true'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ steps.build-config.outputs.image_ref }}
          format: table
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'
          exit-code: '0'

      - name: Push Image
        if: steps.changes.outputs.modified == 'true'
        run: |
          # ë¡œê·¸ì¸ ì¬í™•ì¸ (ì„¸ì…˜ ë§Œë£Œ ë°©ì§€)
          echo "ğŸ” Re-authenticating to Harbor before push..."
          if echo "${{ secrets.HARBOR_PASSWORD }}" | docker login ${{ env.REGISTRY_HOST }} -u "${{ secrets.HARBOR_USERNAME }}" --password-stdin; then
            echo "âœ… Harbor login successful"
          else
            echo "âŒ Harbor login failed"
            exit 1
          fi
          
          # ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
          echo "ğŸ” Verifying login status..."
          docker info | grep -i registry || echo "Registry info check"
          
          echo "ğŸš€ Pushing image: ${{ steps.build-config.outputs.image_ref }}"
          if docker push ${{ steps.build-config.outputs.image_ref }}; then
            echo "âœ… Version tag pushed successfully"
          else
            echo "âŒ Version tag push failed, retrying login..."
            echo "${{ secrets.HARBOR_PASSWORD }}" | docker login ${{ env.REGISTRY_HOST }} -u "${{ secrets.HARBOR_USERNAME }}" --password-stdin
            docker push ${{ steps.build-config.outputs.image_ref }} || exit 1
          fi
          
          echo "ğŸ·ï¸  Tagging as latest: ${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/${{ steps.build-config.outputs.image_name }}:latest"
          docker tag ${{ steps.build-config.outputs.image_ref }} \
              ${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/${{ steps.build-config.outputs.image_name }}:latest
          
          # latest íƒœê·¸ í‘¸ì‹œ ì „ ë¡œê·¸ì¸ ì¬í™•ì¸ (ì„¸ì…˜ ë§Œë£Œ ë°©ì§€)
          echo "ğŸ” Re-authenticating to Harbor before latest tag push..."
          echo "${{ secrets.HARBOR_PASSWORD }}" | docker login ${{ env.REGISTRY_HOST }} -u "${{ secrets.HARBOR_USERNAME }}" --password-stdin
          
          echo "ğŸš€ Pushing latest tag..."
          if docker push ${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/${{ steps.build-config.outputs.image_name }}:latest; then
            echo "âœ… Latest tag pushed successfully"
          else
            echo "âŒ Latest tag push failed, retrying login..."
            echo "${{ secrets.HARBOR_PASSWORD }}" | docker login ${{ env.REGISTRY_HOST }} -u "${{ secrets.HARBOR_USERNAME }}" --password-stdin
            docker push ${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/${{ steps.build-config.outputs.image_name }}:latest || exit 1
          fi
          
          echo "âœ… Successfully pushed to Harbor!"
          echo "   - Version tag: ${{ steps.build-config.outputs.image_ref }}"
          echo "   - Latest tag: ${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/${{ steps.build-config.outputs.image_name }}:latest"

  # Git íƒœê·¸ ìƒì„± ì œê±° - Harbor ì´ë¯¸ì§€ íƒœê·¸ë§Œ ì‚¬ìš©
