name: Smart CI/CD - Scan, Detect Changes, Build, Push

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  REGISTRY_HOST: 192.168.0.240
  HARBOR_PROJECT: ${{ vars.HARBOR_PROJECT || 'service' }}

jobs:
  # ==============================
  # 1) SonarQube ì½”ë“œ ë¶„ì„
  # ==============================
  sonarqube:
    name: SonarQube Analysis
    runs-on: [self-hosted, Linux, X64]
    steps:
      - uses: actions/checkout@v4

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=DZ-CI-CD-Project
            -Dsonar.projectName=DZ-CI-CD-Project
            -Dsonar.sources=services
            -Dsonar.exclusions=**/node_modules/**,**/.next/**,**/build/**,**/dist/**,**/coverage/**,**/shared/**

  # ==============================
  # 2) Version ìžë™ ì¦ê°€ step
  # ==============================
  prepare-version:
    name: Determine Version
    runs-on: ubuntu-latest
    needs: sonarqube
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version
        id: version
        run: |
          git fetch --tags
          latest=$(git tag --list 'v1.*' --sort=-v:refname | head -n 1)
          if [ -z "$latest" ]; then next=0; else next=$(( ${latest#v1.} + 1 )); fi
          echo "version=1.${next}" >> "$GITHUB_OUTPUT"

  # ==============================
  # 3) ì„œë¹„ìŠ¤ ë³€ê²½ ê°ì§€ + Build + Push (ë³‘ë ¬)
  # ==============================
  build-and-push:
    name: Build Changed Services & Deploy to Harbor
    # âš ï¸ ì£¼ì˜: 192.168.0.240ì€ ì‚¬ì„¤ IPì´ë¯€ë¡œ GitHub-hosted runnerì—ì„œ ì ‘ê·¼ ë¶ˆê°€
    # self-hosted runnerë¥¼ ì‚¬ìš©í•´ì•¼ í•¨ (ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì—¬ëŸ¬ runner ë“±ë¡ í•„ìš”)
    runs-on: [self-hosted, Linux, X64]
    needs: prepare-version

    strategy:
      fail-fast: false
      # ë³‘ë ¬ ì²˜ë¦¬: self-hosted runnerê°€ ì—¬ëŸ¬ ê°œ ë“±ë¡ë˜ì–´ ìžˆì–´ì•¼ ë³‘ë ¬ ì‹¤í–‰ë¨
      # runnerê°€ í•˜ë‚˜ë§Œ ìžˆìœ¼ë©´ ìˆœì°¨ ì‹¤í–‰ë¨
      # í•´ê²°: ê°™ì€ ë¼ë²¨(self-hosted, Linux, X64)ë¡œ ì—¬ëŸ¬ VMì— runner ë“±ë¡
      matrix:
        service:
          [
            "frontend-service",
            "backend-services/ai-service",
            "backend-services/auth-service",
            "backend-services/chatbot-service",
            "backend-services/community-service",
            "backend-services/mountain-service",
            "backend-services/notice-service",
            "backend-services/notification-service",
            "backend-services/schedule-service",
            "backend-services/stamp-service",
            "backend-services/store-service",
          ]

    env:
      VERSION: ${{ needs.prepare-version.outputs.version }}
      HARBOR_CA_CRT: ${{ secrets.HARBOR_CA_CRT }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ìµœì‹  ì»¤ë°‹ë§Œ (ì „ì²´ ížˆìŠ¤í† ë¦¬ ë¶ˆí•„ìš”)
          # ë°±ì—”ë“œëŠ” services/ ì „ì²´ê°€ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ë¡œ í•„ìš”í•˜ë¯€ë¡œ sparse-checkout ì‚¬ìš© ë¶ˆê°€
          # ì²´í¬ì•„ì›ƒ ì‹œê°„ì€ ì €ìž¥ì†Œ í¬ê¸°ì— ë¹„ë¡€í•˜ì§€ë§Œ, fetch-depth: 1ë¡œ ìµœì†Œí™”

      # --- Harbor CA ì¸ì¦ì„œ ì„¤ì¹˜ ---
      - name: Install Harbor CA certificate
        if: ${{ env.HARBOR_CA_CRT != '' }}
        run: |
          mkdir -p ~/.docker/certs.d/${{ env.REGISTRY_HOST }}
          printf '%s\n' "$HARBOR_CA_CRT" > ~/.docker/certs.d/${{ env.REGISTRY_HOST }}/ca.crt

      # --- Docker Buildx ì„¤ì • ---
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- ë³€ê²½ ê°ì§€ ---
      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            modified:
              - 'services/${{ matrix.service }}/**'
              - 'services/shared/**'  # shared ë³€ê²½ ì‹œì—ë„ ë¹Œë“œ í•„ìš”

      # --- ë³€ê²½ ê°ì§€ ê²°ê³¼ ì¶œë ¥ (ë””ë²„ê¹…) ---
      - name: Show change detection result
        run: |
          echo "Service: ${{ matrix.service }}"
          echo "Modified: ${{ steps.changes.outputs.modified }}"
          echo "All changes: ${{ steps.changes.outputs.all_modified }}"

      # --- ë³€ê²½ ì—†ìœ¼ë©´ skip ---
      - name: Skip if no changes
        if: steps.changes.outputs.modified != 'true'
        run: echo "â­ No changes detected for ${{ matrix.service }}"

      # --- Harbor ì ‘ê·¼ í…ŒìŠ¤íŠ¸ ---
      - name: Test Harbor connectivity
        if: steps.changes.outputs.modified == 'true'
        run: |
          echo "ðŸ” Testing Harbor connectivity..."
          if curl -k -I https://${{ env.REGISTRY_HOST }} 2>&1 | grep -q "200 OK"; then
            echo "âœ… Harbor is accessible"
          else
            echo "âŒ Harbor is NOT accessible from this runner"
            echo "   Registry: ${{ env.REGISTRY_HOST }}"
            exit 1
          fi

      # --- Build & Push if changed ---
      - name: Login to Harbor
        if: steps.changes.outputs.modified == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_HOST }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Determine image name and build context
        if: steps.changes.outputs.modified == 'true'
        id: build-config
        run: |
          # ì„œë¹„ìŠ¤ ì´ë¦„ ì¶”ì¶œ (ìŠ¬ëž˜ì‹œ ì œê±°, í•˜ì´í”ˆìœ¼ë¡œ ë³€í™˜)
          IMAGE_NAME=$(echo "${{ matrix.service }}" | sed 's|backend-services/||' | sed 's|frontend-service|frontend|')
          
          # í”„ë¡ íŠ¸ì—”ë“œëŠ” frontend-service ë””ë ‰í† ë¦¬ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ, ë°±ì—”ë“œëŠ” services ë””ë ‰í† ë¦¬ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ
          if [[ "${{ matrix.service }}" == "frontend-service" ]]; then
            BUILD_CONTEXT="services/frontend-service"
            DOCKERFILE="services/frontend-service/Dockerfile"
          else
            BUILD_CONTEXT="services"
            DOCKERFILE="services/${{ matrix.service }}/Dockerfile"
          fi
          
          echo "image_name=$IMAGE_NAME" >> "$GITHUB_OUTPUT"
          echo "build_context=$BUILD_CONTEXT" >> "$GITHUB_OUTPUT"
          echo "dockerfile=$DOCKERFILE" >> "$GITHUB_OUTPUT"
          IMAGE_REF="${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/$IMAGE_NAME:${{ env.VERSION }}"
          echo "image_ref=$IMAGE_REF" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Image will be built as: $IMAGE_REF"
          echo "ðŸ“¦ Latest tag: ${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/$IMAGE_NAME:latest"

      - name: Build Image
        if: steps.changes.outputs.modified == 'true'
        run: |
          docker build \
            -f ${{ steps.build-config.outputs.dockerfile }} \
            -t ${{ steps.build-config.outputs.image_ref }} \
            ${{ steps.build-config.outputs.build_context }}

      - name: Trivy vulnerability scan
        if: steps.changes.outputs.modified == 'true'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ steps.build-config.outputs.image_ref }}
          format: table
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'
          exit-code: '0'

      - name: Push Image
        if: steps.changes.outputs.modified == 'true'
        run: |
          echo "ðŸš€ Pushing image: ${{ steps.build-config.outputs.image_ref }}"
          docker push ${{ steps.build-config.outputs.image_ref }} || exit 1
          
          echo "ðŸ·ï¸  Tagging as latest: ${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/${{ steps.build-config.outputs.image_name }}:latest"
          docker tag ${{ steps.build-config.outputs.image_ref }} \
              ${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/${{ steps.build-config.outputs.image_name }}:latest
          
          echo "ðŸš€ Pushing latest tag..."
          docker push ${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/${{ steps.build-config.outputs.image_name }}:latest || exit 1
          
          echo "âœ… Successfully pushed to Harbor!"
          echo "   - Version tag: ${{ steps.build-config.outputs.image_ref }}"
          echo "   - Latest tag: ${{ env.REGISTRY_HOST }}/${{ env.HARBOR_PROJECT }}/${{ steps.build-config.outputs.image_name }}:latest"

  # ==============================
  # 4) Git Tag ì ìš©
  # ==============================
  tag-release:
    name: Tag Release
    runs-on: ubuntu-latest
    needs: build-and-push
    if: needs.build-and-push.result == 'success'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Create tag
        env:
          VERSION: ${{ needs.prepare-version.outputs.version }}
        run: |
          TAG="v${VERSION}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag already exists, skipping"
          else
            git tag "$TAG"
            git push origin "$TAG"
          fi
