global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Stats 페이지
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Frontend - 클라이언트 요청 받기
frontend http_frontend
    bind *:80

    http-request set-header Host %[req.hdr(Host)]
    
    # Frontend vs API 구분
    acl is_api path_beg /api
    acl is_uploads path_beg /uploads
    # 산 정적 파일(geojson/gpx/json)만 Traefik으로 보냄
    acl is_mountain_static path_reg -i ^/mountain/.*\.(gpx|geojson|json)$
    
    # API, /uploads, 산 정적 파일만 Traefik으로, 나머지는 Frontend로
    use_backend traefik_backend if is_api || is_uploads || is_mountain_static
    default_backend frontend_backend

# Backend - Frontend
backend frontend_backend
    server frontend1 frontend:80 check

# Backend - Traefik (API Gateway)
backend traefik_backend
    server traefik1 traefik:80 check

