apiVersion: batch/v1
kind: Job
metadata:
  name: mongodb-init-replica
  namespace: bravo-mongo-ns
spec:
  template:
    spec:
      containers:
      - name: mongodb-init
        image: mongo:7
        command:
        - mongosh
        - --host
        - mongodb-0.mongodb
        - --username
        - admin
        - --password
        - admin123
        - --authenticationDatabase
        - admin
        - --eval
        - |
          try {
            var status = rs.status();
            print("Replica set already initialized");
          } catch (e) {
            print("Initializing replica set...");
            rs.initiate({
              _id: "rs0",
              members: [
                { _id: 0, host: "mongodb-0.mongodb:27017", priority: 2 },
                { _id: 1, host: "mongodb-1.mongodb:27017", priority: 1 },
                { _id: 2, host: "mongodb-2.mongodb:27017", priority: 1 }
              ]
            });
            print("Replica set initialized successfully");
          }
      restartPolicy: OnFailure
  backoffLimit: 3

